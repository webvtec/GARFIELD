<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - Multi Entries</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f9fafb;
      overflow-y: auto;
    }

    #admin-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px 60px;
    }

    h1 {
      text-align: center;
      margin-bottom: 40px;
      color: #2c3e50;
    }

    .section-block {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 40px;
    }

    .section-block h2 {
      margin-top: 0;
      color: #34495e;
    }

    .entry {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
      background: #fefefe;
      position: relative;
    }

    .entry textarea, .entry input[type="url"] {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      font-size: 1rem;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .entry img {
      max-width: 100%;
      max-height: 250px;
      margin-top: 10px;
      display: block;
    }

    .entry-actions {
      margin-top: 10px;
    }

    .entry-actions button {
      margin-right: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    .save-btn {
      background: #3498db;
      color: white;
    }

    .delete-btn {
      background: #e74c3c;
      color: white;
    }

    .add-entry-btn {
      margin-top: 15px;
      background: #2ecc71;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .status-msg {
      font-weight: bold;
      margin-top: 10px;
    }

    .status-success {
      color: green;
    }

    .status-error {
      color: red;
    }
  </style>
</head>
<body>

  <div id="admin-container">
    <h1>Admin Dashboard - Edit Sections</h1>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBtndRroVa279cpMzQlIiphU1W9Uw_Yg6U",
      authDomain: "kravin-delivery.firebaseapp.com",
      projectId: "kravin-delivery",
      storageBucket: "kravin-delivery.appspot.com",
      messagingSenderId: "862159900289",
      appId: "1:862159900289:web:18797ef8343e6329cb0780"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const sections = [
      { id: "default-content", name: "Default Welcome" },
      { id: "res-exterior", name: "Residential - Exterior" },
      { id: "res-interior", name: "Residential - Interior" },
      { id: "com-exterior", name: "Commercial - Exterior" },
      { id: "com-interior", name: "Commercial - Interior" },
      { id: "line-painting", name: "Line Painting" }
    ];

    const container = document.getElementById('admin-container');

    function createUniqueId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    async function loadSections() {
      for (const section of sections) {
        const secDiv = document.createElement('div');
        secDiv.className = 'section-block';
        const h2 = document.createElement('h2');
        h2.textContent = section.name;

        const status = document.createElement('div');
        status.className = 'status-msg';

        const entriesDiv = document.createElement('div');

        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add New Entry';
        addBtn.className = 'add-entry-btn';
        addBtn.onclick = () => {
          const newEntry = { id: createUniqueId(), description: '', image: '' };
          renderEntry(section.id, entriesDiv, newEntry, status);
        };

        secDiv.appendChild(h2);
        secDiv.appendChild(entriesDiv);
        secDiv.appendChild(addBtn);
        secDiv.appendChild(status);
        container.appendChild(secDiv);

        try {
          const doc = await db.collection('sections').doc(section.id).get();
          const data = doc.exists ? doc.data() : {};
          const entries = data.entries || [];

          entries.forEach(entry => {
            renderEntry(section.id, entriesDiv, entry, status);
          });
        } catch (error) {
          status.textContent = 'Error loading section.';
          status.className = 'status-msg status-error';
        }
      }
    }

    function renderEntry(sectionId, container, entry, statusBox) {
      const div = document.createElement('div');
      div.className = 'entry';

      const desc = document.createElement('textarea');
      desc.placeholder = 'Description...';
      desc.value = entry.description || '';

      const imgInput = document.createElement('input');
      imgInput.type = 'url';
      imgInput.placeholder = 'Image URL...';
      imgInput.value = entry.image || '';

      const imgPreview = document.createElement('img');
      if (entry.image) {
        imgPreview.src = entry.image;
      }

      imgInput.addEventListener('input', () => {
        imgPreview.src = imgInput.value.trim();
      });

      const actions = document.createElement('div');
      actions.className = 'entry-actions';

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.className = 'save-btn';

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'delete-btn';

      actions.appendChild(saveBtn);
      actions.appendChild(deleteBtn);

      saveBtn.onclick = async () => {
        const updatedEntry = {
          id: entry.id || createUniqueId(),
          description: desc.value.trim(),
          image: imgInput.value.trim()
        };

        try {
          const ref = db.collection('sections').doc(sectionId);
          const doc = await ref.get();
          let entries = doc.exists && doc.data().entries ? doc.data().entries : [];

          const index = entries.findIndex(e => e.id === updatedEntry.id);
          if (index !== -1) {
            entries[index] = updatedEntry;
          } else {
            entries.push(updatedEntry);
          }

          await ref.set({ entries }, { merge: true });

          statusBox.textContent = 'Saved!';
          statusBox.className = 'status-msg status-success';
        } catch (err) {
          statusBox.textContent = 'Error saving entry.';
          statusBox.className = 'status-msg status-error';
        }
      };

      deleteBtn.onclick = async () => {
        try {
          const ref = db.collection('sections').doc(sectionId);
          const doc = await ref.get();
          let entries = doc.exists && doc.data().entries ? doc.data().entries : [];

          entries = entries.filter(e => e.id !== entry.id);

          await ref.set({ entries }, { merge: true });

          container.removeChild(div);
          statusBox.textContent = 'Entry deleted.';
          statusBox.className = 'status-msg status-success';
        } catch (err) {
          statusBox.textContent = 'Error deleting entry.';
          statusBox.className = 'status-msg status-error';
        }
      };

      div.appendChild(desc);
      div.appendChild(imgInput);
      div.appendChild(imgPreview);
      div.appendChild(actions);
      container.appendChild(div);
    }

    window.onload = loadSections;
  </script>
</body>
</html>
